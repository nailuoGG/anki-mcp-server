# Anki MCP Server å·¥ç¨‹ç»“æ„åˆ†æä¸å¯ç»´æŠ¤æ€§æ”¹è¿›å»ºè®®

## ğŸ“Š é¡¹ç›®ç°çŠ¶åˆ†æ

### é¡¹ç›®æ¦‚è¿°
- **é¡¹ç›®ç±»å‹**: TypeScript Node.js é¡¹ç›®
- **æ ¸å¿ƒåŠŸèƒ½**: Model Context Protocol (MCP) æœåŠ¡å™¨ï¼Œè¿æ¥å¤§è¯­è¨€æ¨¡å‹ä¸ Anki é—ªå¡è½¯ä»¶
- **ä»£ç è§„æ¨¡**: çº¦ 3000+ è¡Œä»£ç ï¼ŒåŒ…å« 8 ä¸ªä¸»è¦æ¨¡å—æ–‡ä»¶

### å½“å‰ç›®å½•ç»“æ„
```
anki-mcp-server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts              # å…¥å£æ–‡ä»¶ (22 è¡Œ)
â”‚   â”œâ”€â”€ ankiMcpServer.ts      # ä¸»æœåŠ¡å™¨ç±» (148 è¡Œ)
â”‚   â”œâ”€â”€ utils.ts              # å·¥å…·å‡½æ•°ä¸å®¢æˆ·ç«¯ (725 è¡Œ) âš ï¸ è¿‡å¤§
â”‚   â”œâ”€â”€ cacheManager.ts       # ç¼“å­˜ç®¡ç† (345 è¡Œ)
â”‚   â”œâ”€â”€ mcpTools.ts           # å·¥å…·å¤„ç†å™¨ (179 è¡Œ)
â”‚   â”œâ”€â”€ mcpResource.ts        # èµ„æºå¤„ç†å™¨ (769 è¡Œ) âš ï¸ è¿‡å¤§
â”‚   â”œâ”€â”€ mcpPrompts.ts         # æç¤ºå¤„ç†å™¨ (758 è¡Œ) âš ï¸ è¿‡å¤§
â”‚   â”œâ”€â”€ _version.ts           # ç‰ˆæœ¬ä¿¡æ¯ (2 è¡Œ)
â”‚   â””â”€â”€ tools/                # å·¥å…·æ¨¡å—ç›®å½•
â”‚       â”œâ”€â”€ baseTool.ts       # å·¥å…·åŸºç±» (237 è¡Œ)
â”‚       â”œâ”€â”€ analysisTools.ts  # åˆ†æå·¥å…· (715 è¡Œ) âš ï¸ è¿‡å¤§
â”‚       â”œâ”€â”€ cardTools.ts      # å¡ç‰‡å·¥å…· (249 è¡Œ)
â”‚       â”œâ”€â”€ deckTools.ts      # ç‰Œç»„å·¥å…· (128 è¡Œ)
â”‚       â”œâ”€â”€ noteTools.ts      # ç¬”è®°å·¥å…· (531 è¡Œ) âš ï¸ è¾ƒå¤§
â”‚       â””â”€â”€ noteTypeTools.ts  # ç¬”è®°ç±»å‹å·¥å…· (258 è¡Œ)
â”œâ”€â”€ assets/                   # é™æ€èµ„æº
â”œâ”€â”€ .github/workflows/        # CI/CD é…ç½®
â”œâ”€â”€ package.json              # é¡¹ç›®é…ç½®
â”œâ”€â”€ tsconfig.json             # TypeScript é…ç½®
â”œâ”€â”€ jest.config.js            # æµ‹è¯•é…ç½®
â””â”€â”€ README.md                 # é¡¹ç›®æ–‡æ¡£
```

## ğŸ” é—®é¢˜è¯†åˆ«

### ğŸš¨ å…³é”®é—®é¢˜

#### 1. **å•æ–‡ä»¶è¿‡å¤§é—®é¢˜**
- `utils.ts` (725 è¡Œ): æ··åˆäº†å®¢æˆ·ç«¯ã€é”™è¯¯å¤„ç†ã€é…ç½®ç­‰å¤šç§èŒè´£
- `mcpResource.ts` (769 è¡Œ): åŒ…å«å¤šç§èµ„æºç±»å‹çš„å¤„ç†é€»è¾‘
- `mcpPrompts.ts` (758 è¡Œ): æ‰€æœ‰æç¤ºæ¨¡æ¿éƒ½åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­
- `analysisTools.ts` (715 è¡Œ): å¤šç§åˆ†æåŠŸèƒ½æ··åœ¨ä¸€èµ·

#### 2. **èŒè´£ä¸æ¸…æ™°**
- `utils.ts` æ‰¿æ‹…äº†å¤ªå¤šè´£ä»»ï¼šå®¢æˆ·ç«¯ã€é”™è¯¯å¤„ç†ã€é…ç½®ç®¡ç†
- ç¼ºä¹æ˜ç¡®çš„åˆ†å±‚æ¶æ„
- å·¥å…·ç±»ä¸ä¸šåŠ¡é€»è¾‘è€¦åˆ

#### 3. **æµ‹è¯•è¦†ç›–ç‡é—®é¢˜**
- CI ä¸­æµ‹è¯•è¢«æ³¨é‡Šæ‰äº†
- ç¼ºä¹ç³»ç»Ÿæ€§çš„æµ‹è¯•ç»„ç»‡
- æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨

#### 4. **é…ç½®ç®¡ç†åˆ†æ•£**
- é…ç½®æ•£å¸ƒåœ¨å¤šä¸ªæ–‡ä»¶ä¸­
- ç¼ºä¹ç»Ÿä¸€çš„é…ç½®ç®¡ç†

## ğŸ¯ å¯ç»´æŠ¤æ€§æ”¹è¿›å»ºè®®

### ğŸ—ï¸ æ¶æ„é‡æ„æ–¹æ¡ˆ

#### 1. **é‡‡ç”¨åˆ†å±‚æ¶æ„**

```
src/
â”œâ”€â”€ core/                     # æ ¸å¿ƒå±‚
â”‚   â”œâ”€â”€ config/              # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ AnkiConfig.ts
â”‚   â”‚   â””â”€â”€ ServerConfig.ts
â”‚   â”œâ”€â”€ errors/              # é”™è¯¯å¤„ç†
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ AnkiErrors.ts
â”‚   â”‚   â””â”€â”€ McpErrors.ts
â”‚   â””â”€â”€ types/               # ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ index.ts
â”‚       â”œâ”€â”€ AnkiTypes.ts
â”‚       â””â”€â”€ McpTypes.ts
â”œâ”€â”€ infrastructure/          # åŸºç¡€è®¾æ–½å±‚
â”‚   â”œâ”€â”€ anki/               # Anki è¿æ¥
â”‚   â”‚   â”œâ”€â”€ AnkiClient.ts
â”‚   â”‚   â”œâ”€â”€ AnkiConnector.ts
â”‚   â”‚   â””â”€â”€ AnkiApiAdapter.ts
â”‚   â”œâ”€â”€ cache/              # ç¼“å­˜ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ CacheManager.ts
â”‚   â”‚   â”œâ”€â”€ PerformanceMonitor.ts
â”‚   â”‚   â””â”€â”€ CacheStrategies.ts
â”‚   â””â”€â”€ mcp/                # MCP åè®®
â”‚       â”œâ”€â”€ McpServer.ts
â”‚       â””â”€â”€ McpTransport.ts
â”œâ”€â”€ application/             # åº”ç”¨å±‚
â”‚   â”œâ”€â”€ handlers/           # å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ ToolHandler.ts
â”‚   â”‚   â”œâ”€â”€ ResourceHandler.ts
â”‚   â”‚   â””â”€â”€ PromptHandler.ts
â”‚   â”œâ”€â”€ services/           # æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ DeckService.ts
â”‚   â”‚   â”œâ”€â”€ NoteService.ts
â”‚   â”‚   â”œâ”€â”€ CardService.ts
â”‚   â”‚   â””â”€â”€ AnalysisService.ts
â”‚   â””â”€â”€ validators/         # éªŒè¯å™¨
â”‚       â”œâ”€â”€ InputValidator.ts
â”‚       â””â”€â”€ SchemaValidator.ts
â”œâ”€â”€ domain/                 # é¢†åŸŸå±‚
â”‚   â”œâ”€â”€ entities/          # å®ä½“
â”‚   â”‚   â”œâ”€â”€ Deck.ts
â”‚   â”‚   â”œâ”€â”€ Note.ts
â”‚   â”‚   â”œâ”€â”€ Card.ts
â”‚   â”‚   â””â”€â”€ NoteType.ts
â”‚   â”œâ”€â”€ repositories/      # ä»“å‚¨æ¥å£
â”‚   â”‚   â”œâ”€â”€ IDeckRepository.ts
â”‚   â”‚   â”œâ”€â”€ INoteRepository.ts
â”‚   â”‚   â””â”€â”€ ICardRepository.ts
â”‚   â””â”€â”€ services/          # é¢†åŸŸæœåŠ¡
â”‚       â”œâ”€â”€ DeckDomainService.ts
â”‚       â””â”€â”€ NoteDomainService.ts
â”œâ”€â”€ presentation/           # è¡¨ç°å±‚
â”‚   â”œâ”€â”€ tools/             # MCP å·¥å…·
â”‚   â”‚   â”œâ”€â”€ deck/
â”‚   â”‚   â”‚   â”œâ”€â”€ ListDecksTool.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ CreateDeckTool.ts
â”‚   â”‚   â”‚   â””â”€â”€ DeleteDeckTool.ts
â”‚   â”‚   â”œâ”€â”€ note/
â”‚   â”‚   â”‚   â”œâ”€â”€ CreateNoteTool.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ SearchNotesTool.ts
â”‚   â”‚   â”‚   â””â”€â”€ UpdateNoteTool.ts
â”‚   â”‚   â””â”€â”€ analysis/
â”‚   â”‚       â”œâ”€â”€ ProgressAnalysisTool.ts
â”‚   â”‚       â””â”€â”€ ConnectionAnalysisTool.ts
â”‚   â”œâ”€â”€ resources/         # MCP èµ„æº
â”‚   â”‚   â”œâ”€â”€ DeckResource.ts
â”‚   â”‚   â”œâ”€â”€ NoteTypeResource.ts
â”‚   â”‚   â””â”€â”€ AnalysisResource.ts
â”‚   â””â”€â”€ prompts/           # MCP æç¤º
â”‚       â”œâ”€â”€ StudyPrompts.ts
â”‚       â”œâ”€â”€ CreationPrompts.ts
â”‚       â””â”€â”€ AnalysisPrompts.ts
â”œâ”€â”€ shared/                # å…±äº«æ¨¡å—
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ StringUtils.ts
â”‚   â”‚   â”œâ”€â”€ DateUtils.ts
â”‚   â”‚   â””â”€â”€ ValidationUtils.ts
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â”œâ”€â”€ AnkiConstants.ts
â”‚   â”‚   â””â”€â”€ McpConstants.ts
â”‚   â””â”€â”€ helpers/
â”‚       â”œâ”€â”€ ResponseFormatter.ts
â”‚       â””â”€â”€ ErrorHandler.ts
â”œâ”€â”€ tests/                 # æµ‹è¯•
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ e2e/
â””â”€â”€ index.ts              # å…¥å£æ–‡ä»¶
```

#### 2. **å·¥å…·æ¨¡å—é‡ç»„**

å°†å½“å‰çš„å·¨å‹å·¥å…·æ–‡ä»¶æ‹†åˆ†ï¼š

```typescript
// å½“å‰: analysisTools.ts (715 è¡Œ)
// é‡æ„ä¸º:
src/presentation/tools/analysis/
â”œâ”€â”€ ProgressAnalysisTool.ts         # å­¦ä¹ è¿›åº¦åˆ†æ
â”œâ”€â”€ ConnectionAnalysisTool.ts       # çŸ¥è¯†è¿æ¥åˆ†æ
â”œâ”€â”€ DifficultyAnalysisTool.ts       # éš¾åº¦åˆ†æ
â”œâ”€â”€ RetentionAnalysisTool.ts        # ä¿ç•™ç‡åˆ†æ
â””â”€â”€ RecommendationTool.ts          # æ¨èç³»ç»Ÿ
```

#### 3. **é…ç½®ç®¡ç†ç»Ÿä¸€**

```typescript
// src/core/config/index.ts
export class ConfigManager {
  private static instance: ConfigManager;
  
  private constructor(
    private ankiConfig: AnkiConfig,
    private serverConfig: ServerConfig,
    private cacheConfig: CacheConfig
  ) {}
  
  static getInstance(): ConfigManager {
    if (!ConfigManager.instance) {
      ConfigManager.instance = new ConfigManager(
        AnkiConfig.fromEnv(),
        ServerConfig.fromEnv(),
        CacheConfig.fromEnv()
      );
    }
    return ConfigManager.instance;
  }
}
```

### ğŸ§ª æµ‹è¯•ç­–ç•¥æ”¹è¿›

#### 1. **æµ‹è¯•ç»„ç»‡ç»“æ„**
```
tests/
â”œâ”€â”€ unit/                  # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ application/
â”‚   â””â”€â”€ presentation/
â”œâ”€â”€ integration/           # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ anki-connection/
â”‚   â”œâ”€â”€ mcp-protocol/
â”‚   â””â”€â”€ end-to-end/
â”œâ”€â”€ fixtures/              # æµ‹è¯•æ•°æ®
â”‚   â”œâ”€â”€ anki-data/
â”‚   â””â”€â”€ mcp-requests/
â””â”€â”€ helpers/               # æµ‹è¯•å·¥å…·
    â”œâ”€â”€ AnkiMockServer.ts
    â”œâ”€â”€ McpTestClient.ts
    â””â”€â”€ TestDataBuilder.ts
```

#### 2. **æµ‹è¯•é…ç½®æ”¹è¿›**
```javascript
// jest.config.js å¢å¼ºç‰ˆ
export default {
  preset: "ts-jest",
  testEnvironment: "node",
  projects: [
    {
      displayName: "unit",
      testMatch: ["<rootDir>/tests/unit/**/*.test.ts"],
      coverageDirectory: "coverage/unit"
    },
    {
      displayName: "integration", 
      testMatch: ["<rootDir>/tests/integration/**/*.test.ts"],
      coverageDirectory: "coverage/integration"
    }
  ],
  collectCoverageFrom: [
    "src/**/*.ts",
    "!src/**/*.d.ts",
    "!src/tests/**/*"
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  }
};
```

### ğŸ“ æ–‡ä»¶ç»„ç»‡æ”¹è¿›

#### 1. **å•ä¸€èŒè´£åŸåˆ™**
- æ¯ä¸ªæ–‡ä»¶ä¸è¶…è¿‡ 300 è¡Œ
- æ¯ä¸ªç±»/å‡½æ•°åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
- æ˜ç¡®çš„æ¨¡å—è¾¹ç•Œ

#### 2. **ä¾èµ–ç®¡ç†**
```typescript
// src/core/di/Container.ts - ä¾èµ–æ³¨å…¥å®¹å™¨
export class DIContainer {
  private services = new Map();
  
  register<T>(token: string, factory: () => T): void {
    this.services.set(token, factory);
  }
  
  resolve<T>(token: string): T {
    const factory = this.services.get(token);
    if (!factory) {
      throw new Error(`Service ${token} not registered`);
    }
    return factory();
  }
}
```

#### 3. **æ¨¡å—å¯¼å‡ºè§„èŒƒ**
```typescript
// æ¯ä¸ªæ¨¡å—çš„ index.ts æ–‡ä»¶è§„èŒƒå¯¼å‡º
export { DeckService } from './DeckService';
export { NoteService } from './NoteService';
export type { IDeckService, INoteService } from './interfaces';
```

### ğŸ”§ å¼€å‘ä½“éªŒæ”¹è¿›

#### 1. **å¼€å‘å·¥å…·é…ç½®**
```json
// .vscode/settings.json
{
  "typescript.preferences.includePackageJsonAutoImports": "off",
  "typescript.suggest.autoImports": true,
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": true,
    "source.fixAll.eslint": true
  }
}
```

#### 2. **Git Hooks å¢å¼º**
```bash
#!/bin/sh
# .husky/pre-commit
npm run lint
npm run type-check
npm run test:unit
npm run build
```

#### 3. **æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ**
```json
// package.json scripts å¢åŠ 
{
  "docs:generate": "typedoc src --out docs",
  "docs:serve": "serve docs",
  "api:schema": "ts-json-schema-generator --path 'src/**/*.ts' --type '*Schema' --out api-schema.json"
}
```

### ğŸš€ éƒ¨ç½²ä¸ç›‘æ§æ”¹è¿›

#### 1. **å¥åº·æ£€æŸ¥**
```typescript
// src/infrastructure/health/HealthChecker.ts
export class HealthChecker {
  async checkAnkiConnection(): Promise<HealthStatus> {
    // æ£€æŸ¥ Anki è¿æ¥çŠ¶æ€
  }
  
  async checkMemoryUsage(): Promise<HealthStatus> {
    // æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
  }
}
```

#### 2. **æ—¥å¿—ç³»ç»Ÿ**
```typescript
// src/infrastructure/logging/Logger.ts
export class Logger {
  private static instance: Logger;
  
  info(message: string, context?: object): void {
    // ç»“æ„åŒ–æ—¥å¿—è®°å½•
  }
  
  error(error: Error, context?: object): void {
    // é”™è¯¯æ—¥å¿—è®°å½•
  }
}
```

## ğŸ“‹ å®æ–½ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ (ç«‹å³å®æ–½)
1. **æ‹†åˆ†å¤§æ–‡ä»¶**: å°† `utils.ts`ã€`mcpResource.ts`ã€`mcpPrompts.ts` æ‹†åˆ†
2. **å»ºç«‹æµ‹è¯•**: æ¢å¤å¹¶å®Œå–„æµ‹è¯•å¥—ä»¶
3. **é”™è¯¯å¤„ç†ç»Ÿä¸€**: å»ºç«‹ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ (1-2 å‘¨å†…)
1. **é‡æ„å·¥å…·æ¨¡å—**: æŒ‰åŠŸèƒ½åŸŸé‡æ–°ç»„ç»‡å·¥å…·
2. **é…ç½®ç®¡ç†**: ç»Ÿä¸€é…ç½®ç®¡ç†
3. **ä¾èµ–æ³¨å…¥**: å¼•å…¥ DI å®¹å™¨è§£è€¦ä¾èµ–

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ (é•¿æœŸè§„åˆ’)
1. **å®Œæ•´åˆ†å±‚æ¶æ„**: å®æ–½å®Œæ•´çš„åˆ†å±‚æ¶æ„
2. **æ€§èƒ½ç›‘æ§**: æ·»åŠ æ€§èƒ½ç›‘æ§å’ŒæŒ‡æ ‡
3. **æ–‡æ¡£å®Œå–„**: å®Œå–„ API æ–‡æ¡£å’Œæ¶æ„æ–‡æ¡£

## ğŸ¯ é¢„æœŸæ”¶ç›Š

å®æ–½è¿™äº›æ”¹è¿›åï¼Œé¡¹ç›®å°†è·å¾—ï¼š

- **âœ… æ›´å¥½çš„å¯è¯»æ€§**: å•æ–‡ä»¶ä»£ç é‡å‡å°‘ 60%+
- **âœ… æ›´å®¹æ˜“ä¿®æ”¹**: æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œå’ŒèŒè´£åˆ†ç¦»
- **âœ… æ›´å¼ºçš„æµ‹è¯•è¦†ç›–**: æµ‹è¯•è¦†ç›–ç‡æå‡åˆ° 80%+
- **âœ… æ›´å¿«çš„å¼€å‘é€Ÿåº¦**: æ˜ç¡®çš„æ¶æ„æŒ‡å¯¼å’Œå¼€å‘è§„èŒƒ
- **âœ… æ›´å°‘çš„ Bug**: ç±»å‹å®‰å…¨å’Œæµ‹è¯•ä¿éšœ
- **âœ… æ›´ç®€å•çš„ç»´æŠ¤**: æ¨¡å—åŒ–è®¾è®¡ä¾¿äºå®šä½å’Œä¿®å¤é—®é¢˜

é€šè¿‡è¿™äº›æ”¹è¿›ï¼Œé¡¹ç›®å°†å…·å¤‡æ›´å¥½çš„å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œå¼€å‘ä½“éªŒã€‚