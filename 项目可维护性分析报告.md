# Anki MCP Server 工程结构分析与可维护性改进建议

## 📊 项目现状分析

### 项目概述
- **项目类型**: TypeScript Node.js 项目
- **核心功能**: Model Context Protocol (MCP) 服务器，连接大语言模型与 Anki 闪卡软件
- **代码规模**: 约 3000+ 行代码，包含 8 个主要模块文件

### 当前目录结构
```
anki-mcp-server/
├── src/
│   ├── index.ts              # 入口文件 (22 行)
│   ├── ankiMcpServer.ts      # 主服务器类 (148 行)
│   ├── utils.ts              # 工具函数与客户端 (725 行) ⚠️ 过大
│   ├── cacheManager.ts       # 缓存管理 (345 行)
│   ├── mcpTools.ts           # 工具处理器 (179 行)
│   ├── mcpResource.ts        # 资源处理器 (769 行) ⚠️ 过大
│   ├── mcpPrompts.ts         # 提示处理器 (758 行) ⚠️ 过大
│   ├── _version.ts           # 版本信息 (2 行)
│   └── tools/                # 工具模块目录
│       ├── baseTool.ts       # 工具基类 (237 行)
│       ├── analysisTools.ts  # 分析工具 (715 行) ⚠️ 过大
│       ├── cardTools.ts      # 卡片工具 (249 行)
│       ├── deckTools.ts      # 牌组工具 (128 行)
│       ├── noteTools.ts      # 笔记工具 (531 行) ⚠️ 较大
│       └── noteTypeTools.ts  # 笔记类型工具 (258 行)
├── assets/                   # 静态资源
├── .github/workflows/        # CI/CD 配置
├── package.json              # 项目配置
├── tsconfig.json             # TypeScript 配置
├── jest.config.js            # 测试配置
└── README.md                 # 项目文档
```

## 🔍 问题识别

### 🚨 关键问题

#### 1. **单文件过大问题**
- `utils.ts` (725 行): 混合了客户端、错误处理、配置等多种职责
- `mcpResource.ts` (769 行): 包含多种资源类型的处理逻辑
- `mcpPrompts.ts` (758 行): 所有提示模板都在一个文件中
- `analysisTools.ts` (715 行): 多种分析功能混在一起

#### 2. **职责不清晰**
- `utils.ts` 承担了太多责任：客户端、错误处理、配置管理
- 缺乏明确的分层架构
- 工具类与业务逻辑耦合

#### 3. **测试覆盖率问题**
- CI 中测试被注释掉了
- 缺乏系统性的测试组织
- 测试文件不存在

#### 4. **配置管理分散**
- 配置散布在多个文件中
- 缺乏统一的配置管理

## 🎯 可维护性改进建议

### 🏗️ 架构重构方案

#### 1. **采用分层架构**

```
src/
├── core/                     # 核心层
│   ├── config/              # 配置管理
│   │   ├── index.ts
│   │   ├── AnkiConfig.ts
│   │   └── ServerConfig.ts
│   ├── errors/              # 错误处理
│   │   ├── index.ts
│   │   ├── AnkiErrors.ts
│   │   └── McpErrors.ts
│   └── types/               # 类型定义
│       ├── index.ts
│       ├── AnkiTypes.ts
│       └── McpTypes.ts
├── infrastructure/          # 基础设施层
│   ├── anki/               # Anki 连接
│   │   ├── AnkiClient.ts
│   │   ├── AnkiConnector.ts
│   │   └── AnkiApiAdapter.ts
│   ├── cache/              # 缓存管理
│   │   ├── CacheManager.ts
│   │   ├── PerformanceMonitor.ts
│   │   └── CacheStrategies.ts
│   └── mcp/                # MCP 协议
│       ├── McpServer.ts
│       └── McpTransport.ts
├── application/             # 应用层
│   ├── handlers/           # 处理器
│   │   ├── ToolHandler.ts
│   │   ├── ResourceHandler.ts
│   │   └── PromptHandler.ts
│   ├── services/           # 服务层
│   │   ├── DeckService.ts
│   │   ├── NoteService.ts
│   │   ├── CardService.ts
│   │   └── AnalysisService.ts
│   └── validators/         # 验证器
│       ├── InputValidator.ts
│       └── SchemaValidator.ts
├── domain/                 # 领域层
│   ├── entities/          # 实体
│   │   ├── Deck.ts
│   │   ├── Note.ts
│   │   ├── Card.ts
│   │   └── NoteType.ts
│   ├── repositories/      # 仓储接口
│   │   ├── IDeckRepository.ts
│   │   ├── INoteRepository.ts
│   │   └── ICardRepository.ts
│   └── services/          # 领域服务
│       ├── DeckDomainService.ts
│       └── NoteDomainService.ts
├── presentation/           # 表现层
│   ├── tools/             # MCP 工具
│   │   ├── deck/
│   │   │   ├── ListDecksTool.ts
│   │   │   ├── CreateDeckTool.ts
│   │   │   └── DeleteDeckTool.ts
│   │   ├── note/
│   │   │   ├── CreateNoteTool.ts
│   │   │   ├── SearchNotesTool.ts
│   │   │   └── UpdateNoteTool.ts
│   │   └── analysis/
│   │       ├── ProgressAnalysisTool.ts
│   │       └── ConnectionAnalysisTool.ts
│   ├── resources/         # MCP 资源
│   │   ├── DeckResource.ts
│   │   ├── NoteTypeResource.ts
│   │   └── AnalysisResource.ts
│   └── prompts/           # MCP 提示
│       ├── StudyPrompts.ts
│       ├── CreationPrompts.ts
│       └── AnalysisPrompts.ts
├── shared/                # 共享模块
│   ├── utils/
│   │   ├── StringUtils.ts
│   │   ├── DateUtils.ts
│   │   └── ValidationUtils.ts
│   ├── constants/
│   │   ├── AnkiConstants.ts
│   │   └── McpConstants.ts
│   └── helpers/
│       ├── ResponseFormatter.ts
│       └── ErrorHandler.ts
├── tests/                 # 测试
│   ├── unit/
│   ├── integration/
│   └── e2e/
└── index.ts              # 入口文件
```

#### 2. **工具模块重组**

将当前的巨型工具文件拆分：

```typescript
// 当前: analysisTools.ts (715 行)
// 重构为:
src/presentation/tools/analysis/
├── ProgressAnalysisTool.ts         # 学习进度分析
├── ConnectionAnalysisTool.ts       # 知识连接分析
├── DifficultyAnalysisTool.ts       # 难度分析
├── RetentionAnalysisTool.ts        # 保留率分析
└── RecommendationTool.ts          # 推荐系统
```

#### 3. **配置管理统一**

```typescript
// src/core/config/index.ts
export class ConfigManager {
  private static instance: ConfigManager;
  
  private constructor(
    private ankiConfig: AnkiConfig,
    private serverConfig: ServerConfig,
    private cacheConfig: CacheConfig
  ) {}
  
  static getInstance(): ConfigManager {
    if (!ConfigManager.instance) {
      ConfigManager.instance = new ConfigManager(
        AnkiConfig.fromEnv(),
        ServerConfig.fromEnv(),
        CacheConfig.fromEnv()
      );
    }
    return ConfigManager.instance;
  }
}
```

### 🧪 测试策略改进

#### 1. **测试组织结构**
```
tests/
├── unit/                  # 单元测试
│   ├── core/
│   ├── domain/
│   ├── application/
│   └── presentation/
├── integration/           # 集成测试
│   ├── anki-connection/
│   ├── mcp-protocol/
│   └── end-to-end/
├── fixtures/              # 测试数据
│   ├── anki-data/
│   └── mcp-requests/
└── helpers/               # 测试工具
    ├── AnkiMockServer.ts
    ├── McpTestClient.ts
    └── TestDataBuilder.ts
```

#### 2. **测试配置改进**
```javascript
// jest.config.js 增强版
export default {
  preset: "ts-jest",
  testEnvironment: "node",
  projects: [
    {
      displayName: "unit",
      testMatch: ["<rootDir>/tests/unit/**/*.test.ts"],
      coverageDirectory: "coverage/unit"
    },
    {
      displayName: "integration", 
      testMatch: ["<rootDir>/tests/integration/**/*.test.ts"],
      coverageDirectory: "coverage/integration"
    }
  ],
  collectCoverageFrom: [
    "src/**/*.ts",
    "!src/**/*.d.ts",
    "!src/tests/**/*"
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  }
};
```

### 📁 文件组织改进

#### 1. **单一职责原则**
- 每个文件不超过 300 行
- 每个类/函数只负责一个功能
- 明确的模块边界

#### 2. **依赖管理**
```typescript
// src/core/di/Container.ts - 依赖注入容器
export class DIContainer {
  private services = new Map();
  
  register<T>(token: string, factory: () => T): void {
    this.services.set(token, factory);
  }
  
  resolve<T>(token: string): T {
    const factory = this.services.get(token);
    if (!factory) {
      throw new Error(`Service ${token} not registered`);
    }
    return factory();
  }
}
```

#### 3. **模块导出规范**
```typescript
// 每个模块的 index.ts 文件规范导出
export { DeckService } from './DeckService';
export { NoteService } from './NoteService';
export type { IDeckService, INoteService } from './interfaces';
```

### 🔧 开发体验改进

#### 1. **开发工具配置**
```json
// .vscode/settings.json
{
  "typescript.preferences.includePackageJsonAutoImports": "off",
  "typescript.suggest.autoImports": true,
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": true,
    "source.fixAll.eslint": true
  }
}
```

#### 2. **Git Hooks 增强**
```bash
#!/bin/sh
# .husky/pre-commit
npm run lint
npm run type-check
npm run test:unit
npm run build
```

#### 3. **文档自动生成**
```json
// package.json scripts 增加
{
  "docs:generate": "typedoc src --out docs",
  "docs:serve": "serve docs",
  "api:schema": "ts-json-schema-generator --path 'src/**/*.ts' --type '*Schema' --out api-schema.json"
}
```

### 🚀 部署与监控改进

#### 1. **健康检查**
```typescript
// src/infrastructure/health/HealthChecker.ts
export class HealthChecker {
  async checkAnkiConnection(): Promise<HealthStatus> {
    // 检查 Anki 连接状态
  }
  
  async checkMemoryUsage(): Promise<HealthStatus> {
    // 检查内存使用情况
  }
}
```

#### 2. **日志系统**
```typescript
// src/infrastructure/logging/Logger.ts
export class Logger {
  private static instance: Logger;
  
  info(message: string, context?: object): void {
    // 结构化日志记录
  }
  
  error(error: Error, context?: object): void {
    // 错误日志记录
  }
}
```

## 📋 实施优先级

### 🔴 高优先级 (立即实施)
1. **拆分大文件**: 将 `utils.ts`、`mcpResource.ts`、`mcpPrompts.ts` 拆分
2. **建立测试**: 恢复并完善测试套件
3. **错误处理统一**: 建立统一的错误处理机制

### 🟡 中优先级 (1-2 周内)
1. **重构工具模块**: 按功能域重新组织工具
2. **配置管理**: 统一配置管理
3. **依赖注入**: 引入 DI 容器解耦依赖

### 🟢 低优先级 (长期规划)
1. **完整分层架构**: 实施完整的分层架构
2. **性能监控**: 添加性能监控和指标
3. **文档完善**: 完善 API 文档和架构文档

## 🎯 预期收益

实施这些改进后，项目将获得：

- **✅ 更好的可读性**: 单文件代码量减少 60%+
- **✅ 更容易修改**: 清晰的模块边界和职责分离
- **✅ 更强的测试覆盖**: 测试覆盖率提升到 80%+
- **✅ 更快的开发速度**: 明确的架构指导和开发规范
- **✅ 更少的 Bug**: 类型安全和测试保障
- **✅ 更简单的维护**: 模块化设计便于定位和修复问题

通过这些改进，项目将具备更好的可维护性、可扩展性和开发体验。