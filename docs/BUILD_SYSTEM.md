# Build System Documentation

This document provides detailed information about the build system used in the Anki MCP Server project.

## Overview

The build system is designed to handle the complete development and release workflow, including TypeScript compilation, version management, and package creation.

## Architecture

### Core Components

1. **TypeScript Compilation** - Handled by tsup
2. **Version Management** - Custom scripts for synchronization
3. **Package Creation** - mcpb pack for MCP packages
4. **SHA256 Calculation** - Security verification

### Build Scripts

```
scripts/
‚îú‚îÄ‚îÄ build.js              # Main build orchestrator
‚îú‚îÄ‚îÄ update-manifest.js    # Manifest version management
‚îú‚îÄ‚îÄ update-version.js     # Server version management
‚îî‚îÄ‚îÄ tsup-version-plugin.js # TSUP plugin (unused)
```

## Build Process

### Development Build

```bash
npm run build
```

**Process:**
1. Compile TypeScript files (`tsup`)
2. Update `manifest.json` version
3. Execute `mcpb pack`
4. Generate `.mcpb` file in `release/` directory

### Production Build

```bash
npm run build:prod
```

**Process:**
1. All development build steps
2. Calculate SHA256 for `.mcpb` file
3. Update `server.json` with version and SHA256
4. Complete version synchronization

### Build Without MCPB

```bash
npm run build:no-mcpb
```

**Process:**
1. Compile TypeScript files
2. Update `manifest.json` version
3. Skip mcpb packaging

## Script Details

### build.js

The main build orchestrator that handles the complete build sequence.

**Features:**
- Command line argument parsing
- Environment detection
- Error handling and logging
- Conditional execution based on mode

**Usage:**
```bash
node scripts/build.js [options]

Options:
  --prod     Production mode (updates server.json)
  --no-mcpb  Skip mcpb packaging
```

**Environment Variables:**
- `NODE_ENV=production` - Enables production mode

### update-manifest.js

Updates the version number in `manifest.json` to match `package.json`.

**Process:**
1. Read `package.json` version
2. Update `manifest.json` version
3. Write updated file

### update-version.js

Updates `server.json` with version information and calculates SHA256.

**Process:**
1. Read `package.json` version
2. Calculate SHA256 for `.mcpb` file
3. Update `server.json` version and SHA256
4. Update package URLs

## Configuration

### tsup.config.ts

TypeScript compilation configuration:

```typescript
export default defineConfig({
  entry: ["src/index.ts"],
  format: ["esm"],
  clean: true,
  dts: false,
  target: "node18",
  splitting: false,
  sourcemap: false,
  minify: true,
  shims: false,
  inject: [],
  esbuildOptions(options) {
    options.resolveExtensions = [".ts", ".tsx", ".js", ".jsx"];
  },
  env: {
    NODE_ENV: process.env.NODE_ENV || "development",
  },
});
```

### package.json Scripts

```json
{
  "scripts": {
    "dev": "tsup --watch",
    "build": "node scripts/build.js",
    "build:prod": "node scripts/build.js --prod",
    "build:no-mcpb": "node scripts/build.js --no-mcpb",
    "release": "node scripts/build.js --prod",
    "test": "jest --runInBand --detectOpenHandles",
    "format": "biome format . --write",
    "lint": "biome lint src/",
    "check": "biome check --apply ."
  }
}
```

## Version Management

### Version Synchronization

The build system automatically synchronizes version numbers across:

- `package.json` - Source of truth
- `manifest.json` - MCP manifest
- `server.json` - MCP server configuration

### Version Update Logic

```javascript
// Development mode
if (!isProduction) {
  // Only update manifest.json
  updateManifestJson(manifestData, version);
}

// Production mode
if (isProduction) {
  // Update all files
  updateManifestJson(manifestData, version);
  updateServerJson(serverData, version, mcpbSha256);
}
```

### SHA256 Calculation

For security verification, the build system calculates SHA256 for the `.mcpb` file:

```javascript
function calculateFileSha256(filePath) {
  const fileBuffer = fs.readFileSync(filePath);
  const hashSum = crypto.createHash("sha256");
  hashSum.update(fileBuffer);
  return hashSum.digest("hex");
}
```

## File Structure

### Input Files

- `src/` - TypeScript source files
- `package.json` - Project configuration
- `manifest.json` - MCP manifest
- `server.json` - MCP server configuration

### Output Files

- `dist/` - Compiled JavaScript files
- `release/anki-mcp-server.mcpb` - MCP package file

### Generated Files

- `src/_version.ts` - Version constant (generated by prebuild)

## Error Handling

### Build Failures

The build system includes comprehensive error handling:

```javascript
function execCommand(command, description) {
  try {
    console.log(`üîÑ ${description}...`);
    execSync(command, { stdio: "inherit" });
    console.log(`‚úÖ ${description} completed`);
    return true;
  } catch (error) {
    console.error(`‚ùå ${description} failed:`, error.message);
    return false;
  }
}
```

### Common Error Scenarios

1. **TypeScript compilation errors**
   - Check syntax and type errors
   - Verify import statements

2. **mcpb pack failures**
   - Ensure Anki is running
   - Check AnkiConnect is enabled

3. **File not found errors**
   - Verify file paths
   - Check file permissions

## Performance

### Build Times

- **TypeScript compilation**: ~2-3 seconds
- **mcpb pack**: ~5-10 seconds
- **SHA256 calculation**: ~1 second
- **Total build time**: ~10-15 seconds

### Optimization

- **Incremental builds**: tsup handles incremental compilation
- **Parallel processing**: Commands run sequentially for reliability
- **Caching**: Node.js module caching

## Troubleshooting

### Debug Mode

Enable detailed logging:

```bash
DEBUG=* npm run build
```

### Common Issues

#### ES Module Errors

**Problem**: `require is not defined`
**Solution**: Ensure scripts use ES module syntax

#### Version Sync Issues

**Problem**: Version numbers don't match
**Solution**: Run `npm run version:all`

#### Build Failures

**Problem**: Command execution fails
**Solution**: Check error messages and fix underlying issues

### Logging

The build system provides detailed logging:

- **Progress indicators**: `üîÑ`, `‚úÖ`, `‚ùå`
- **Version information**: Current version display
- **SHA256 output**: Security verification
- **Error messages**: Detailed error reporting

## Integration

### CI/CD Integration

The build system is designed to work with CI/CD pipelines:

```yaml
# Example GitHub Actions workflow
- name: Build
  run: npm run build:prod

- name: Test
  run: npm run test

- name: Upload artifacts
  uses: actions/upload-artifact@v3
  with:
    name: mcpb-package
    path: release/
```

### IDE Integration

The build system works with various IDEs:

- **VS Code**: TypeScript support, task runner
- **WebStorm**: Built-in TypeScript support
- **Vim/Neovim**: LSP support

## Future Improvements

### Potential Enhancements

1. **Parallel execution**: Run independent tasks in parallel
2. **Build caching**: Cache intermediate results
3. **Incremental mcpb**: Only rebuild when necessary
4. **Plugin system**: Extensible build plugins
5. **Build profiles**: Different build configurations

### Monitoring

Consider adding:

- Build time metrics
- Success/failure rates
- Performance monitoring
- Error tracking

---

For more information, see the [Development Guide](DEVELOPMENT.md) or the main [README](../README.md).
